version: '3.8'
# Docker Compose 파일 버전 - 애플리케이션 스택 전용

services:
  # ========== Spring Boot 애플리케이션 ==========
  app:
    # ✨ [핵심] CI/CD 파이프라인에서는 APP_IMAGE_URI 환경변수를 주입받아 ECR 이미지를 사용합니다.
    # 로컬 환경에서는 이 변수가 없으므로 build: . 설정을 통해 이미지를 직접 빌드합니다.
    image: ${APP_IMAGE_URI:-aod-app:latest}
    container_name: aod-app
    ports:
      - "${APP_PORT:-8080}:8080"
    environment:
      TZ: Asia/Seoul
      # JVM 메모리 설정 (t3.small 최적화: Heap 최대 512MB)
      JAVA_TOOL_OPTIONS: "-Duser.timezone=Asia/Seoul -Xms256m -Xmx512m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILE:-prod}

      # ✨ [핵심 수정] 외부 DB 및 Selenium을 참조하도록 환경 변수 사용
      # 이 값들은 GitHub Actions Secrets를 통해 주입됩니다.
      SPRING_DATASOURCE_URL: jdbc:postgresql://${POSTGRES_HOST}:${POSTGRES_PORT}/${POSTGRES_DB}
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}

      TMDB_API_KEY: ${TMDB_API_KEY}
      STEAM_API_KEY: ${STEAM_API_KEY}
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      
      # Sentry 에러 추적
      SENTRY_DSN: ${SENTRY_DSN}

    # 리소스 제한 (t3.small 최적화)
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1.5G
        reservations:
          cpus: '0.5'
          memory: 512M

    networks:
      - aod-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ========== 네트워크 정의 ==========
# 다른 스택(예: 모니터링)과 통신이 필요할 경우 external network로 변경할 수 있습니다.
networks:
  aod-network:
    driver: bridge
